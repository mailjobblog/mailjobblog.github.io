<!DOCTYPE html>
<html  lang="zh-CN" >
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>PT 工具解决 Mysql 主从复制一致性问题 | 李斌的技术博客</title>
    <meta name="keywords" content="李斌的技术博客,php,go,java,swoole,linux,mysql,编程,程序员,redis,mongodb,大数据分析,汀风说后端" />
    <meta name="description" content="前言  在搭建主从的时候，默认是一个异步的过程，所以难免出现数据延迟。 虽然用同步复制（参考下文链接），可以解决数据延迟问题，但是牺牲了一些性能，并不利于生产环境的需求。 所以，对于主从复制的属于不一致问题，我们尽可能的使用高可用的方法和方案，去做到一个更高的方案。 下面介绍一款工具： Percona Toolkit 简称 pt  工具  参考文献  Percona Toolkit安装：https">
<meta property="og:type" content="article">
<meta property="og:title" content="PT 工具解决 Mysql 主从复制一致性问题">
<meta property="og:url" content="https://blog.mailjob.net/posts/1867559540.html">
<meta property="og:site_name" content="李斌的技术博客">
<meta property="og:description" content="前言  在搭建主从的时候，默认是一个异步的过程，所以难免出现数据延迟。 虽然用同步复制（参考下文链接），可以解决数据延迟问题，但是牺牲了一些性能，并不利于生产环境的需求。 所以，对于主从复制的属于不一致问题，我们尽可能的使用高可用的方法和方案，去做到一个更高的方案。 下面介绍一款工具： Percona Toolkit 简称 pt  工具  参考文献  Percona Toolkit安装：https">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.github.mailjob.net/oss.github/20210218205612.png">
<meta property="og:image" content="http://img.github.mailjob.net/oss.github/20210219015027.png">
<meta property="og:image" content="http://img.github.mailjob.net/oss.github/20210219021612.png">
<meta property="og:image" content="http://img.github.mailjob.net/oss.github/20210219000905.png">
<meta property="og:image" content="http://img.github.mailjob.net/oss.github/20210219001123.png">
<meta property="og:image" content="http://img.github.mailjob.net/oss.github/20210219020228.png">
<meta property="article:published_time" content="2021-02-18T07:48:25.000Z">
<meta property="article:modified_time" content="2026-02-28T10:56:06.982Z">
<meta property="article:author" content="汀风">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="高可用">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.github.mailjob.net/oss.github/20210218205612.png">

    <link rel="alternate" type="application/atom+xml" href="/atom.xml">
    <link rel="icon" href="https://img.github.mailjob.net/logo/tingfeng.ico" type="image/x-icon">

    
<link rel="stylesheet" href="/css/common.min.css">



    
    
    
    
        <link href="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/css/lightgallery.min.css" rel="stylesheet">
    
    
    
<link rel="stylesheet" href="/css/iconfont.min.css">

    

    
<link rel="stylesheet" href="/css/prism.css">

<meta name="generator" content="Hexo 5.4.2"></head>
    <body>
        <header class="header header-fixture">
    <div class="profile-search-wrap flex sm:block">
        
        
        <div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6">
            <a id="avatar" role="link" href="https://github.com/jefferyjob" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer" >
                <img src="https://img.github.mailjob.net/logo/tingfeng.jpg" class="rounded-full" alt="avatar">
            </a>
            <h2 id="name" class="hidden lg:block">李斌</h2>
            <h3 id="title" class="hidden xl:block">此平台用作学习交流日常分享</h3>
            
            <small id="location" class="hidden lg:block">
                <i class="iconfont icon-map-icon"></i>
                Beijin, China
            </small>
            
        </div>
        
        
<div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full">
    <form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200">
        <div class="input-group table bg-gray-100 lg:bg-white w-full">
            <input id="search-input" type="text" placeholder="搜索" class="inline-block w-full bg-gray-100 lg:bg-white">
            <span class="table-cell">
                <button name="search tigger button" disabled>
                    <i class="iconfont icon-search m-2"></i>
                </button>
            </span>
        </div>
    </form>
        
<div id="content-json" data-placeholder="搜索" class="invisible hidden">/content.json</div>
<script id="search-teamplate" type="text/html" data-path="/content.json">
    <div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="搜索" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div>
</script>

</div>


        <button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false">
            <i class="iconfont icon-hamburger"></i>
        </button>
    </div>
    <nav id="menu-nav" class="hidden sm:flex flex-col">
        
        
            <div class="menu-item menu-home" role="menuitem">
                <a href="/.">
                    <i class="iconfont icon-home" aria-hidden="true"></i>
                    <span class="menu-title">首页</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-archives" role="menuitem">
                <a href="/archives">
                    <i class="iconfont icon-archive" aria-hidden="true"></i>
                    <span class="menu-title">归档</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-categories" role="menuitem">
                <a href="/categories">
                    <i class="iconfont icon-folder" aria-hidden="true"></i>
                    <span class="menu-title">分类</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-tags" role="menuitem">
                <a href="/tags">
                    <i class="iconfont icon-tag" aria-hidden="true"></i>
                    <span class="menu-title">标签</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-links" role="menuitem">
                <a href="/links">
                    <i class="iconfont icon-friend" aria-hidden="true"></i>
                    <span class="menu-title">友链</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-about" role="menuitem">
                <a href="/about">
                    <i class="iconfont icon-cup" aria-hidden="true"></i>
                    <span class="menu-title">关于</span>
                </a>
            </div>
        
        
<div class="social-links flex sm:flex-col lg:hidden mt-5">
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://github.com/jefferyjob">
                <i class="iconfont social-icon icon-github"></i>
                <span class="menu-title hidden lg:inline">menu.github</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://blog.csdn.net/libinemail">
                <i class="iconfont social-icon icon-csdn"></i>
                <span class="menu-title hidden lg:inline">menu.csdn</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://juejin.cn/user/782508009723783">
                <i class="iconfont social-icon icon-juejin"></i>
                <span class="menu-title hidden lg:inline">menu.juejin</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a href="/atom.xml">
                <i class="iconfont social-icon icon-rss"></i>
                <span class="menu-title hidden lg:inline">menu.rss</span>
            </a>
        </span>
    
</div>


    </nav>
</header>

        <section class="main-section">
            
    <main class="flex-1 px-4 py-14 md:px-5 lg:px-8 lg:py-4 relative min-h-screen">
    

    <article class="content article article-archives article-type-list" itemscope="">
        <header class="article-header">
            
    
        <h1 class="article-title text-lg" itemprop="name">
            PT 工具解决 Mysql 主从复制一致性问题
        </h1>
    



            <p class="article-meta mb-3 text-xs">
                <span class="article-date">
    <i class="iconfont icon-calendar-check"></i>
	<a href="/posts/1867559540.html" class="article-date">
	  <time datetime="2021-02-18T07:48:25.000Z" itemprop="datePublished">2021-02-18</time>
	</a>
</span>

                
    <span class="article-category">
    <i class="iconfont icon-folder"></i>
    <a class="article-category-link" href="/categories/mysql/">mysql</a>
  </span>


                
    <span class="article-tags">
    <i class="iconfont icon-tag"></i>
    <a class="article-tag-none-link" href="/tags/mysql/" rel="tag">mysql</a>, <a class="article-tag-none-link" href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/" rel="tag">高可用</a>
  </span>


                <span class="_partial/post-comment"><i class="icon icon-comment"></i>
                    <a href="/posts/1867559540.html#comments" class="article-comment-link">
                        评论
                    </a>
                </span>
                
    
        <span class="post-wordcount" itemprop="wordCount">字数统计: 3k(字)</span>
    
    
        <span class="post-readcount" itemprop="timeRequired">阅读时长: 13(分)</span>
    


            </p>
        </header>
        <div class="marked-body article-body">
            <h2 id="前言">前言</h2>
<blockquote>
<p>在搭建主从的时候，默认是一个异步的过程，所以难免出现数据延迟。</p>
<p>虽然用同步复制（参考下文链接），可以解决数据延迟问题，但是牺牲了一些性能，并不利于生产环境的需求。</p>
<p>所以，对于主从复制的属于不一致问题，我们尽可能的使用高可用的方法和方案，去做到一个更高的方案。</p>
<p>下面介绍一款工具：</p>
<p><code>Percona Toolkit</code> 简称 <code>pt </code> 工具</p>
</blockquote>
<h2 id="参考文献">参考文献</h2>
<blockquote>
<p>Percona Toolkit安装：<a href="https://blog.mailjob.net/posts/1022633166.html">https://blog.mailjob.net/posts/1022633166.html</a></p>
<p>主从原理（同步复制）：<a href="https://blog.mailjob.net/posts/3006260634.html">https://blog.mailjob.net/posts/3006260634.html</a></p>
<p>优秀博文：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/kevingrace/p/6261091.html">https://www.cnblogs.com/kevingrace/p/6261091.html</a></p>
</blockquote>
<h2 id="mysql-主从存在的一些问题">mysql 主从存在的一些问题</h2>
<blockquote>
<p>异步同步复制延迟<br>
MySQL的Bug感<br>
网络中断<br>
服务器崩溃<br>
非正常关闭<br>
等其他一些错误。</p>
</blockquote>
<h2 id="PT-工具校验">PT 工具校验</h2>
<p><strong>接下来我用以下3个工具做数据校验</strong></p>
<ol>
<li>pt-table-checksum 负责检测MySQL主从数据一致性</li>
<li>pt-table-sync负责挡住从数据不一致时修复数据，让他们保存数据的一致性</li>
<li>pt-heartbeat 负责监控MySQL主从同步延迟</li>
</ol>
<p><strong>在mysql主从实战从，我搭建了一组主从，如下</strong></p>
<table>
<thead>
<tr>
<th>容器名称</th>
<th>版本</th>
<th>IP</th>
<th>端口</th>
<th>root账号密码</th>
<th>slave账号密码</th>
</tr>
</thead>
<tbody>
<tr>
<td>mysql1（主）</td>
<td>5.7</td>
<td>172.17.0.2</td>
<td>33061-&gt;3306</td>
<td>root  root</td>
<td>slave  slave</td>
</tr>
<tr>
<td>mysql2（从）</td>
<td>5.7</td>
<td>172.17.0.3</td>
<td>33062-&gt;3306</td>
<td>root  root</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>现在我在从库（mysql2）中添加一些数据，使其形成数据不一致</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>pt_test<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>pt_id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pt_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>pt_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">4</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Records of pt_test</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>pt_test<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'qwer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>pt_test<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'zxcvbn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>pt_test<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'159852'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>这里我添加的是从库，如果是主库的话，数据会被主从同步过去，没法进行接下来的演示了</p>
<p>所以当前的数据就是不一致的了，从库的数据多于主库</p>
</blockquote>
<p><img src="http://img.github.mailjob.net/oss.github/20210218205612.png" alt=""></p>
<h3 id="PT-检测数据不一致">PT 检测数据不一致</h3>
<blockquote>
<p>在 <code>mysql </code> 主从实战搭建中，我曾经创建了一个 <code>blog_db</code> 数据库，然后里面创建了一个 <code>user</code> 表</p>
<p>我现在在 slave库（从）中添加一条数据，这样就会导致主从不一致，便于接下来的测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</blockquote>
<p><strong>在主库服务器执行命令查验</strong></p>
<pre class="line-numbers language-none"><code class="language-none">pt-table-checksum --nocheck-replication-filters --no-check-binlog-format --replicate&#x3D;test.checksums --recursion-method&#x3D;hosts --databases&#x3D;blog_db h&#x3D;127.0.0.1,u&#x3D;root,p&#x3D;root,P&#x3D;33061<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>返回结果如下</strong></p>
<pre class="line-numbers language-none"><code class="language-none">Checking if all tables can be checksummed ...
Starting checksum ...
            TS ERRORS  DIFFS     ROWS  DIFF_ROWS  CHUNKS SKIPPED    TIME TABLE
02-19T01:47:05      0      1        2          1       1       0   0.040 blog_db.user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="http://img.github.mailjob.net/oss.github/20210219015027.png" alt=""></p>
<p><strong>返回参数说明</strong></p>
<pre class="line-numbers language-none"><code class="language-none">TS ：完成检查的时间。
ERRORS ：检查时候发生错误和警告的数量。
DIFFS ：0表示一致，1表示不一致。当指定--no-replicate-check时，会一直为0，当指定--replicate-check-only会显示不同的信息。
ROWS ：表的行数。
CHUNKS ：被划分到表中的块的数目。
SKIPPED ：由于错误或警告或过大，则跳过块的数目。
TIME ：执行的时间。
TABLE ：被检查的表名。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>信息数据会记录在check_data表中</strong></p>
<pre class="line-numbers language-none"><code class="language-none">mysql&gt; use check_data;

mysql&gt; show tables;
+----------------------+
| Tables_in_check_data |
+----------------------+
| checksums            |
+----------------------+
1 row in set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="问题：">问题：</h4>
<p><strong>1、Diffs cannot be detected because no slaves were found.  Please read the --recursion-method documentation for information</strong></p>
<p>这个是由于，master库（主）找不到slave库（从）导致的问题。在主库查看从库的 <code>hosts</code> 信息发现是空的：</p>
<pre class="line-numbers language-none"><code class="language-none">show slave hosts;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="http://img.github.mailjob.net/oss.github/20210219021612.png" alt="image-20210219000953186"></p>
<p>a、把slave库（从）的账户连接权限对主库开放</p>
<blockquote>
<p>我这里是图方便，授权了 root 账户，实际搭建中确不能这么做，存在安全隐患</p>
<p>建议在，搭建主从的时候，开发和主授权给从，同样的账号和密码，然后再使用 pt 工具中，就可以使用这个账号和密码进行数据检查和同步了</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">mysql&gt; GRANT SELECT, PROCESS, SUPER, REPLICATION SLAVE ON *.* TO &#39;root&#39;@&#39;172.17.0.2&#39; IDENTIFIED BY &#39;root&#39;;
mysql&gt; flush privileges;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>b、更改slave库（从）的配置文件 <code>my.cnf</code> ，添加从的ip和端口信息</p>
<pre class="line-numbers language-none"><code class="language-none">[mysqld]
report_host&#x3D;IP_INFO
report_port&#x3D;3306<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="http://img.github.mailjob.net/oss.github/20210219000905.png" alt=""></p>
<p>再次在 master库（主）查看从库的 <code>hosts</code> 信息发现ok了</p>
<p><img src="http://img.github.mailjob.net/oss.github/20210219001123.png" alt=""></p>
<h3 id="PT-恢复数据">PT 恢复数据</h3>
<p><strong>在主库服务器执行以下命令查验</strong></p>
<pre class="line-numbers language-none"><code class="language-none">pt-table-sync --replicate&#x3D;check_data.checksums h&#x3D;127.0.0.1,u&#x3D;root,p&#x3D;root,P&#x3D;33061 h&#x3D;127.0.0.1,u&#x3D;root,p&#x3D;root,P&#x3D;33062 --print<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>先master的ip，用户，密码，然后是slave的ip，用户，密码</strong></p>
<p>–sync-to-master ：指定一个DSN，即从的IP，他会通过show processlist或show slave status 去自动的找主。<br>
–print       ：打印，但不执行命令。<br>
–execute     ：执行命令。</p>
</blockquote>
<p><strong>返回结果</strong></p>
<pre class="line-numbers language-none"><code class="language-none">DELETE FROM &#96;blog_db&#96;.&#96;user&#96; WHERE &#96;id&#96;&#x3D;&#39;3&#39; LIMIT 1 &#x2F;*percona-toolkit src_db:blog_db src_tbl:user src_dsn:P&#x3D;33061,h&#x3D;127.0.0.1,p&#x3D;...,u&#x3D;root dst_db:blog_db dst_tbl:user dst_dsn:P&#x3D;3306,h&#x3D;172.17.0.3,p&#x3D;...,u&#x3D;root lock:1 transaction:1 changing_src:check_data.checksums replicate:check_data.checksums bidirectional:0 pid:27104 user:root host:VM-0-15-centos*&#x2F;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>数据恢复同步命令</strong></p>
<pre class="line-numbers language-none"><code class="language-none">pt-table-sync --replicate&#x3D;check_data.checksums h&#x3D;127.0.0.1,u&#x3D;root,p&#x3D;root,P&#x3D;33061 h&#x3D;127.0.0.1,u&#x3D;root,p&#x3D;root,P&#x3D;33062 --execute<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>再次查看，是否存在问题，结果ok</strong></p>
<p><img src="http://img.github.mailjob.net/oss.github/20210219020228.png" alt="image-20210219020225574"></p>
<h2 id="pt-heartbeat-监控-mysql-延迟">pt-heartbeat 监控 mysql 延迟</h2>
<blockquote>
<p>对于MySQL数据库主从复制延迟的监控，可以借助percona的有力武器 <code>pt-heartbeat</code> 来实现。<br>
pt-heartbeat的工作原理通过使用时间戳方式在主库上更新特定表，然后在从库上读取被更新的时间戳然后与本地系统时间对比来得出其延迟。</p>
<p>具体流程：<br>
1）在主库上创建一张heartbeat表，按照一定的时间频率更新该表的字段（把时间更新进去）。监控操作运行后，<code>heartbeat</code> 表能促使主从同步！<br>
2）连接到从库上检查复制的时间记录，和从库的当前系统时间进行比较，得出时间的差异。</p>
</blockquote>
<p><strong>master库（主）上创建一个 <code>hearbeat</code> 表</strong>：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">use</span> check_data<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> heartbeat <span class="token punctuation">(</span>
    ts <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    server_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    <span class="token keyword">file</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token comment">-- SHOW MASTER STATUS</span>
    position <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token comment">-- SHOW MASTER STATUS</span>
    relay_master_log_file <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token comment">-- SHOW SLAVE STATUS</span>
    exec_master_log_pos <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token comment">-- SHOW SLAVE STATUS</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>更新主库（master）上的 <code>heartbeat</code> (注意这个启动操作要在主库服务器上执行)</strong></p>
<p><code>--interval=1</code> 表示 <code>1秒钟</code> 更新一次</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 命令执行</span>
<span class="token punctuation">[</span>root@VM-0-15-centos src<span class="token punctuation">]</span><span class="token comment"># pt-heartbeat --ask-pass --user=root --host=127.0.0.1 --port=33061 --create-table --database blog_db --interval=1 --interval=1 --update --replace --daemonize</span>
Enter password: 

<span class="token comment"># Tips：</span>
我这里检测的库只有 <span class="token parameter variable">--database</span> blog_db ，建议是生产环境中不要加入这个。这样可以监测全部数据库

<span class="token comment"># 查看是否启动</span>
<span class="token punctuation">[</span>root@VM-0-15-centos src<span class="token punctuation">]</span><span class="token comment"># ps -ef|grep pt-heartbeat</span>
root      <span class="token number">6306</span>     <span class="token number">1</span>  <span class="token number">0</span> 03:01 ?        00:00:00 perl /usr/bin/pt-heartbeat --ask-pass <span class="token parameter variable">--user</span><span class="token operator">=</span>root <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">33061</span> --create-table <span class="token parameter variable">--database</span> blog_db <span class="token parameter variable">--interval</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--interval</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--update</span> <span class="token parameter variable">--replace</span> <span class="token parameter variable">--daemonize</span>
root      <span class="token number">6667</span>  <span class="token number">5386</span>  <span class="token number">0</span> 03:02 pts/0    00:00:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto pt-heartbeat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>查看监测结果</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@VM-0-15-centos src<span class="token punctuation">]</span><span class="token comment"># pt-heartbeat --database blog_db --table=heartbeat --monitor --host=127.0.0.1 --port=33061 --user=root --password=root --master-server-id=1</span>
<span class="token number">0</span>.00s <span class="token punctuation">[</span>  <span class="token number">0</span>.00s,  <span class="token number">0</span>.00s,  <span class="token number">0</span>.00s <span class="token punctuation">]</span>
<span class="token number">0</span>.02s <span class="token punctuation">[</span>  <span class="token number">0</span>.00s,  <span class="token number">0</span>.00s,  <span class="token number">0</span>.00s <span class="token punctuation">]</span>
<span class="token number">0</span>.00s <span class="token punctuation">[</span>  <span class="token number">0</span>.00s,  <span class="token number">0</span>.00s,  <span class="token number">0</span>.00s <span class="token punctuation">]</span>
<span class="token number">0</span>.00s <span class="token punctuation">[</span>  <span class="token number">0</span>.00s,  <span class="token number">0</span>.00s,  <span class="token number">0</span>.00s <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这其中 0.02s 表示延迟了 ，没有延迟是为0 而 [ 0.00s, 0.00s, 0.00s ] 则表示1m,5m,15m的平均值，</p>
<p>而这其中中需要注意的是 <code>--master-server-id</code> 为主服务器的服务id就是在 <code>my.cnf</code> 中配置的 <code>server_id</code> 的值</p>
<h6 id="其他问题">其他问题</h6>
<p>如果想把这个输出结果加入自动化监控，那么可以使用如下命令使监控输出写到文件，然后使用脚本定期过滤文件中的最大值作为预警即可：<br>
注意–log选项必须在有–daemonize参数的时候才会打印到文件中，且这个文件的路径最好在/tmp下，否则可能因为权限问题无法创建</p>
<pre class="line-numbers language-none"><code class="language-none">[root@master-server ~]# pt-heartbeat -D huanqiu --table&#x3D;heartbeat --monitor --host&#x3D;192.168.1.102 --user&#x3D;root --password&#x3D;123456 --log&#x3D;&#x2F;opt&#x2F;master-slave.txt --daemonize
[root@master-server ~]# tail -f &#x2F;opt&#x2F;master-slave.txt       &#x2F;&#x2F;可以测试，在主库上更新数据时，从库上是否及时同步，如不同步，可以在这里看到监控的延迟数据
0.00s [ 0.00s, 0.00s, 0.00s ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>下面是编写的主从同步延迟监控脚本，就是定期过滤–log文件中最大值（此脚本运行的前提是：启动更新主库heartbeat命令以及带上–log的同步延迟检测命令）。如果发生延迟，发送报警邮件</p>
<pre class="line-numbers language-none"><code class="language-none">[root@master-server ~]# cat &#x2F;root&#x2F;check-slave-monit.sh  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;bin&#x2F;bash
cat &#x2F;opt&#x2F;master-slave.txt &gt; &#x2F;opt&#x2F;master_slave.txt
echo &gt; &#x2F;opt&#x2F;master-slave.txt
max_time&#x3D;&#96;cat &#x2F;opt&#x2F;master_slave.txt |grep -v &#39;^$&#39; |awk &#39;&#123;print $1&#125;&#39; |sort -k1nr |head -1&#96;
NUM&#x3D;$(echo &quot;$max_time&quot;|cut -d&quot;s&quot; -f1)
if [ $NUM &#x3D;&#x3D; &quot;0.00&quot; ];then
   echo &quot;Mysql主从数据一致&quot;
else
   &#x2F;usr&#x2F;local&#x2F;bin&#x2F;sendEmail -f ops@163.com -t wang@163.com -s smtp.email.cn -u &quot;Mysql主从同步延迟&quot; -o message-content-type&#x3D;html -o message-charset&#x3D;utf8 -xu ops@huanqiu.cn -xp WEE78@12l$ -m &quot;Mysql主从数据同步有延迟&quot;
fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>最后总结</strong>：<br>
通过pt-heartbeart工具可以很好的弥补默认主从延迟的问题，但需要搞清楚该工具的原理。<br>
默认的Seconds_Behind_Master值是通过将服务器当前的时间戳与二进制日志中的事件时间戳相对比得到的，所以只有在执行事件时才能报告延时。备库复制线程没有运行，也会报延迟null。<br>
还有一种情况：大事务，一个事务更新数据长达一个小时，最后提交。这条更新将比它实际发生时间要晚一个小时才记录到二进制日志中。当备库执行这条语句时，会临时地报告备库延迟为一个小时，执行完后又很快变成0</p>
<h2 id="便捷管理">便捷管理</h2>
<h5 id="1、使用-shell-进行定时查验和同步数据">1、使用 shell 进行定时查验和同步数据</h5>
<blockquote>
<p>要做的是：创建一个 shell 脚本，定时的去检查数据的一致性，如果发现延迟问题，自动的存储日志和同步数据。</p>
<p>当然，你也可以做到对于延迟的比较厉害的从库进行 linux email 通知运维人员</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span>
<span class="token assign-left variable">NUM</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>pt-table-checksum --nocheck-replication-filters <span class="token parameter variable">--replicate</span><span class="token operator">=</span>check_data.checksums --no-check-binlog-format <span class="token parameter variable">--databases</span><span class="token operator">=</span>mytest <span class="token parameter variable">--tables</span><span class="token operator">=</span>t <span class="token parameter variable">--user</span><span class="token operator">=</span>mytest <span class="token parameter variable">--password</span><span class="token operator">=</span>rot <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'NR>1&#123;sum+=$3&#125;END&#123;print sum&#125;'</span><span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$NUM</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
<span class="token builtin class-name">echo</span> <span class="token string">"Data is ok!"</span>
<span class="token keyword">else</span>
<span class="token builtin class-name">echo</span> <span class="token string">"Data is error!"</span>
pt-table-sync --sync-to-master <span class="token assign-left variable">h</span><span class="token operator">=</span><span class="token number">192.168</span>.29.103,u<span class="token operator">=</span>mytest,p<span class="token operator">=</span>rot,P<span class="token operator">=</span><span class="token number">3306</span> <span class="token parameter variable">--databases</span><span class="token operator">=</span>mytest <span class="token parameter variable">--print</span>
pt-table-sync --sync-to-master <span class="token assign-left variable">h</span><span class="token operator">=</span><span class="token number">192.168</span>.29.103,u<span class="token operator">=</span>mytest,p<span class="token operator">=</span>rot,P<span class="token operator">=</span><span class="token number">3306</span> <span class="token parameter variable">--databases</span><span class="token operator">=</span>mytest <span class="token parameter variable">--execute</span>
pt-table-sync --sync-to-master <span class="token assign-left variable">h</span><span class="token operator">=</span><span class="token number">192.168</span>.29.104,u<span class="token operator">=</span>mytest,p<span class="token operator">=</span>rot,P<span class="token operator">=</span><span class="token number">3306</span> <span class="token parameter variable">--databases</span><span class="token operator">=</span>mytest <span class="token parameter variable">--print</span>
pt-table-sync --sync-to-master <span class="token assign-left variable">h</span><span class="token operator">=</span><span class="token number">192.168</span>.29.104,u<span class="token operator">=</span>mytest,p<span class="token operator">=</span>rot,P<span class="token operator">=</span><span class="token number">3306</span> <span class="token parameter variable">--databases</span><span class="token operator">=</span>mytest <span class="token parameter variable">--execute</span>
<span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="主从不一致其他解决方案">主从不一致其他解决方案</h2>
<h4 id="1、减少锁竞争">1、减少锁竞争</h4>
<p>如果查询导致大量的表锁定，需要考虑重构查询语句，尽量避免过多的锁。</p>
<h4 id="2、负载均衡">2、负载均衡</h4>
<p>搭建多少slave，并且使用lvs或nginx进行查询负载均衡，可以减少每个slave执行查询的次数和时间，从而将更多的时间用于去处理主从同步。</p>
<h4 id="3、salve较高的机器配置">3、salve较高的机器配置</h4>
<h4 id="4、slave调整参数">4、slave调整参数</h4>
<p>为了保障较高的数据安全性，<strong>配置sync_binlog=1，innodb_flush_log_at_trx_commit=1等设置</strong>。<strong>而Slave可以关闭binlog，innodb_flush_log_at_trx_commit也可以设置为0来提高sql的执行效率</strong>（这两个参数很管用）</p>
<h4 id="5、并行复制">5、并行复制</h4>
<p>即将单线程的复制改成多线程复制。</p>
<p>从库有两个线程与复制相关：io_thread 负责从主库拿binlog并写到relaylog， sql_thread 负责读relaylog并执行。</p>
<p><strong>多线程的思路就是把sql_thread 变成分发线程，然后由一组worker_thread来负责执行。</strong></p>
<p>几乎所有的并行复制都是这个思路，有不同的，便是sql_thread 的分发策略。</p>
<p><strong>MySQL5.7的真正并行复制 enhanced multi-threaded slave（MTS）很好的解决了主从同步复制的延迟问题。</strong></p>

        </div>
        
<blockquote class="copyright">
    <p><strong>本文链接 : </strong><a class="permalink" href="https://blog.mailjob.net/posts/1867559540.html">https://blog.mailjob.net/posts/1867559540.html</a></p>
    <p><strong>This article is available under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a> License</strong></p>
</blockquote>


    </article>
    
    <section id="comments">
        
    </section>


    

</main>


<aside style="" id="sidebar" class="aside aside-fixture">
    <div class="toc-sidebar">
        <nav id="toc" class="article-toc">
            <h3 class="toc-title">文章目录</h3>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-text">参考文献</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E4%B8%BB%E4%BB%8E%E5%AD%98%E5%9C%A8%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="toc-text">mysql 主从存在的一些问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PT-%E5%B7%A5%E5%85%B7%E6%A0%A1%E9%AA%8C"><span class="toc-text">PT 工具校验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PT-%E6%A3%80%E6%B5%8B%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4"><span class="toc-text">PT 检测数据不一致</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%EF%BC%9A"><span class="toc-text">问题：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PT-%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE"><span class="toc-text">PT 恢复数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pt-heartbeat-%E7%9B%91%E6%8E%A7-mysql-%E5%BB%B6%E8%BF%9F"><span class="toc-text">pt-heartbeat 监控 mysql 延迟</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98"><span class="toc-text">其他问题</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%BF%E6%8D%B7%E7%AE%A1%E7%90%86"><span class="toc-text">便捷管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E4%BD%BF%E7%94%A8-shell-%E8%BF%9B%E8%A1%8C%E5%AE%9A%E6%97%B6%E6%9F%A5%E9%AA%8C%E5%92%8C%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">1、使用 shell 进行定时查验和同步数据</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E4%B8%8D%E4%B8%80%E8%87%B4%E5%85%B6%E4%BB%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">主从不一致其他解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E5%87%8F%E5%B0%91%E9%94%81%E7%AB%9E%E4%BA%89"><span class="toc-text">1、减少锁竞争</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">2、负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81salve%E8%BE%83%E9%AB%98%E7%9A%84%E6%9C%BA%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">3、salve较高的机器配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81slave%E8%B0%83%E6%95%B4%E5%8F%82%E6%95%B0"><span class="toc-text">4、slave调整参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E5%B9%B6%E8%A1%8C%E5%A4%8D%E5%88%B6"><span class="toc-text">5、并行复制</span></a></li></ol></li></ol></li></ol>
        </nav>
    </div>
</aside>





        </section>
        <footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40">
    
    <div class="footer-social-links">
        
            <a target="_blank" rel="noopener" href="https://github.com/jefferyjob">
                <i class="iconfont icon-github"></i>
            </a>
        
            <a target="_blank" rel="noopener" href="https://blog.csdn.net/libinemail">
                <i class="iconfont icon-csdn"></i>
            </a>
        
            <a target="_blank" rel="noopener" href="https://juejin.cn/user/782508009723783">
                <i class="iconfont icon-juejin"></i>
            </a>
        
            <a href="/atom.xml">
                <i class="iconfont icon-rss"></i>
            </a>
        
    </div>
    
    
        <p class="footer-custom">京ICP备17056825号</p>
        <p class="theme-brand">Copyright by <a href="//blog.mailjob.net" rel="nofollow noopener noreferrer">mailjob.net</a></p>
    

    <script src="/js/prism.js" async></script>
</footer>
        <div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div>
        <div id="search-view-container" class="hidden shadow-xl"></div>
        
<script src="/js/dom-event.min.js"></script>



<script src="/js/local-search.min.js"></script>



    <script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script>
    
<script src="/js/light-gallery.min.js"></script>






    </body>
</html>
<!-- 百度站长推送 -->
<script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https'){
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else{
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

<!--友盟统计-->
<span style="display: none;">
    <script type="text/javascript" src="https://s9.cnzz.com/z_stat.php?id=1279692087&web_id=1279692087"></script>
</span>
